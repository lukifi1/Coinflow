<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinFlow - Expense Overview</title>
    <link rel="stylesheet" href="style/expenses.css">
    <link rel="stylesheet" href="style/global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
    <div id="navbar"></div>
    <div class="expense-container">
        <header>
            <h1>Your Expense</h1>
            <div class="header-actions">
                <button id="deleteSelectedBtn" class="bulk-delete-btn" style="display: none;">Delete Selected</button>
                <a href="/dashboard.html" class="back-link">← Back to Dashboard</a>
                <a href="/add-expense.html" class="add-expense-btn">- New Expense</a>
                <a href="/upload-expense.html" class="add-expense-btn">- Bulk Upload Expenses</a>
                <a id="exportCsvBtn" class="add-expense-btn">Export CSV</a>
            </div>
        </header>

        <div id="expenseList" class="expense-list">
            <p>Loading expenses...</p>
        </div>
    </div>

    <script>

        let currencySymbol = "€"; // default

        async function loadUserCurrencySymbol(user_uuid) {
            try {
                const res = await fetch(`/api/settings/${user_uuid}`);
                if (res.ok) {
                    const settings = await res.json();
                    if (settings.currency_symbol) {
                        currencySymbol = settings.currency_symbol;
                    }
                }
            } catch (err) {
                console.warn("Currency symbol fallback to €");
            }
        }
        // Global UUID access
        const storage = localStorage.getItem("session_token") ? localStorage : sessionStorage;
        const uuid = storage.getItem("user_uuid");

        function showConfirmModal(onConfirm) {
            const modal = document.getElementById("confirmModal");
            modal.style.display = "flex";

            const yesBtn = document.getElementById("confirmYes");
            const noBtn = document.getElementById("confirmNo");

            const cleanup = () => {
                modal.style.display = "none";
                yesBtn.removeEventListener("click", confirmHandler);
                noBtn.removeEventListener("click", cancelHandler);
            };

            const confirmHandler = () => {
                cleanup();
                onConfirm();
            };

            const cancelHandler = () => cleanup();

            yesBtn.addEventListener("click", confirmHandler);
            noBtn.addEventListener("click", cancelHandler);
        }

        fetch("/navbar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;
                document.getElementById("logoutBtn")?.addEventListener("click", () => {
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = "/login.html";
                });
            });

        document.addEventListener("DOMContentLoaded", async () => {
            document.getElementById("exportCsvBtn").addEventListener("click", () => {
                const rows = document.querySelectorAll(".expense-table tbody tr");
                if (!rows.length) {
                    showAlert("No expense records to export.", "error");
                    return;
                }

                const headers = ["Name", "Amount", "Tags", "Date", "Month", "Account"];
                const csvRows = [headers.join(",")];

                rows.forEach(row => {
                    const name = row.children[1].textContent.trim();
                    const amount = row.children[2].textContent.trim().replace(currencySymbol, "");
                    const tags = row.children[3].textContent.trim();
                    const date = row.children[4].textContent.trim();
                    const month = row.children[5].textContent.trim();
                    const account = row.children[6].textContent.trim();

                    const csvRow = [name, amount, tags, date, month, account]
                        .map(value => `"${value.replace(/"/g, '""')}"`) // escape quotes
                        .join(",");
                    csvRows.push(csvRow);
                });

                const csvContent = csvRows.join("\n");
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "expense_data.csv");
                link.style.display = "none";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            const expenseList = document.getElementById("expenseList");

            if (!uuid) {
                window.location.href = "/login.html";
                return;
            }

            const updateCheckboxListeners = () => {
                const selectAll = document.getElementById("selectAll");
                const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
                const checkboxes = document.querySelectorAll(".row-checkbox");

                if (!selectAll || !deleteSelectedBtn) return;

                selectAll.addEventListener("change", () => {
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                    deleteSelectedBtn.style.display = checkboxes.length > 0 && selectAll.checked ? "inline-block" : "none";
                });

                checkboxes.forEach(cb => {
                    cb.addEventListener("change", () => {
                        const anyChecked = [...checkboxes].some(c => c.checked);
                        deleteSelectedBtn.style.display = anyChecked ? "inline-block" : "none";
                    });
                });

                deleteSelectedBtn.addEventListener("click", () => {
                    const selectedIds = [...checkboxes]
                        .filter(cb => cb.checked)
                        .map(cb => cb.dataset.id);

                    if (selectedIds.length === 0) return;

                    showConfirmModal(async () => {
                        for (const id of selectedIds) {
                            try {
                                const res = await fetch(`/api/expense/${uuid}/${id}`, { method: "DELETE" });
                                if (res.ok) {
                                    const row = document.querySelector(`input[data-id="${id}"]`)?.closest("tr");
                                    if (row) {
                                        row.classList.add("fade-out");
                                        setTimeout(() => {
                                            row.remove();
                                            updateTotalSum(); // update the sum after removing
                                            const tbody = document.querySelector(".expense-table tbody");
                                            if (!tbody || tbody.rows.length === 0) {
                                                incomeList.innerHTML = '<p class="fade-in">No income records found.</p>';
                                            }
                                        }, 400);
                                    }
                                }
                            } catch (err) {
                                console.error(`Failed to delete income ${id}`, err);
                            }
                        }

                        showAlert("Selected expenses deleted.", "success");
                        deleteSelectedBtn.style.display = "none";
                        document.getElementById("selectAll").checked = false;
                    });
                });
            };

            try {
                await loadUserCurrencySymbol(uuid);

                const [expensesRes, accountsRes] = await Promise.all([
                    fetch(`/api/expenses/${uuid}`),
                    fetch(`/api/accounts/${uuid}`)
                ]);

                const expenses = await expensesRes.json();
                const accounts = await accountsRes.json();

                if (!expensesRes.ok || !Array.isArray(expenses)) throw new Error("Failed to load expenses.");
                if (!accountsRes.ok || !Array.isArray(accounts)) throw new Error("Failed to load accounts.");

                const accountMap = Object.fromEntries(accounts.map(acc => [acc.uuid, acc.name]));

                if (expenses.length === 0) {
                    expenseList.innerHTML = '<p>No expense records found.</p>';
                    return;
                }

                let total = 0;
                const rows = expenses.map(expense => {
                    total += parseFloat(expense.amount);
                    const accountName = accountMap[expense.account_uuid] || '—';
                    return `
  <tr>
    <td><input type="checkbox" class="row-checkbox" data-id="${expense.uuid}" /></td>
    <td><i class="fas fa-arrow-down icon"></i>${expense.name}</td>
    <td>${currencySymbol}-${parseFloat(expense.amount).toFixed(2)}</td>
    <td><span class="tag">${expense.tags?.join(', ') || '-'}</span></td>
    <td>${new Date(expense.date || expense.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
    <td>${expense.month}</td>
    <td>${accountName}</td>
    <td><button class="delete-btn" data-id="${expense.uuid}" title="Delete"><i class="fas fa-trash-alt"></i></button></td>
  </tr>`;
                }).join('');

                expenseList.innerHTML = `
      <table class="expense-table">
        <thead>
  <tr>
    <th><input type="checkbox" id="selectAll" title="Select All" /></th>
    <th class="sortable" data-key="name">Name <i class="fas fa-sort"></i></th>
    <th class="sortable" data-key="amount">Amount <i class="fas fa-sort"></i></th>
    <th class="sortable" data-key="tags">Tags <i class="fas fa-sort"></i></th>
    <th class="sortable" data-key="created_at">Date <i class="fas fa-sort"></i></th>
    <th class="sortable" data-key="month">Month <i class="fas fa-sort"></i></th>
    <th class="sortable" data-key="account_name">Account <i class="fas fa-sort"></i></th>
    <th>Actions</th>
  </tr>
</thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr>
            <td colspan="8" class="total-row">Total Expense: <span id="totalSum">${currencySymbol}-${total.toFixed(2)}</span></td>
          </tr>
        </tfoot>
      </table>`;

                updateCheckboxListeners();

                document.querySelectorAll(".delete-btn").forEach(button => {
                    button.addEventListener("click", () => {
                        const id = button.dataset.id;

                        showConfirmModal(async () => {
                            const res = await fetch(`/api/expense/${uuid}/${id}`, { method: "DELETE" });
                            const result = await res.json();

                            if (res.ok) {
                                const row = button.closest("tr");
                                row.classList.add("fade-out");
                                setTimeout(() => {
                                    row.remove();
                                    const tbody = document.querySelector(".expense-table tbody");
                                    if (!tbody || tbody.rows.length === 0) {
                                        expenseList.innerHTML = '<p class="fade-in">No expense records found.</p>';
                                    }
                                }, 400);
                                showAlert("Expense deleted.", "success");
                            } else {
                                showAlert(result.error || "Failed to delete expense.", "error");
                            }
                        });
                    });
                });

            } catch (err) {
                console.error(err);
                expenseList.innerHTML = '<p class="error">Failed to load expense data.</p>';
            }
        });

        function showAlert(message, type = "success") {
            const alert = document.createElement("div");
            alert.className = `alert-box ${type}`;
            alert.innerText = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
        function updateTotalSum() {
            const rows = document.querySelectorAll(".expense-table tbody tr");
            let newTotal = 0;

            rows.forEach(row => {
                const amountCell = row.querySelector("td:nth-child(3)");
                if (amountCell) {
                    const amount = parseFloat(amountCell.textContent.replace(/[^\d.-]/g, ""));
                    if (!isNaN(amount)) newTotal += amount;
                }
            });

            const totalElem = document.getElementById("totalSum");
            if (totalElem) {
                totalElem.textContent = `${currencySymbol}${newTotal.toFixed(2)}`;
            }
        }
        let currentSort = { key: null, direction: "asc" };

        document.addEventListener("click", e => {
            const header = e.target.closest(".sortable");
            if (!header) return;

            const key = header.dataset.key;
            const direction = (currentSort.key === key && currentSort.direction === "asc") ? "desc" : "asc";
            currentSort = { key, direction };

            sortTableByKey(key, direction);
            updateSortIcons(key, direction);
        });

        function sortTableByKey(key, direction) {
            const tbody = document.querySelector(".expense-table tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));

            rows.sort((a, b) => {
                const aData = extractCellValue(a, key);
                const bData = extractCellValue(b, key);

                if (typeof aData === "number" && typeof bData === "number") {
                    return direction === "asc" ? aData - bData : bData - aData;
                }

                return direction === "asc"
                    ? String(aData).localeCompare(String(bData))
                    : String(bData).localeCompare(String(aData));
            });

            tbody.innerHTML = "";
            rows.forEach(row => tbody.appendChild(row));
        }

        function extractCellValue(row, key) {
            switch (key) {
                case "name":
                    return row.children[1].textContent.trim().toLowerCase();
                case "amount":
                    return parseFloat(row.children[2].textContent.replace(/[^\d.-]/g, ""));
                case "tags":
                    return row.children[3].textContent.trim().toLowerCase();
                case "created_at":
                    return new Date(row.children[4].textContent);
                case "month":
                    return row.children[5].textContent.trim().toLowerCase();
                case "account_name":
                    return row.children[6].textContent.trim().toLowerCase();
                default:
                    return "";
            }
        }

        function updateSortIcons(activeKey, direction) {
            document.querySelectorAll(".sortable").forEach(th => {
                th.classList.remove("active");
                const icon = th.querySelector("i");
                icon.className = "fas fa-sort";
                if (th.dataset.key === activeKey) {
                    th.classList.add("active");
                    icon.className = direction === "asc" ? "fas fa-sort-up" : "fas fa-sort-down";
                }
            });
        }
    </script>

    <div id="confirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <p>Are you sure you want to delete this expense?</p>
            <div class="modal-actions">
                <button id="confirmYes" class="modal-btn danger">Yes, delete</button>
                <button id="confirmNo" class="modal-btn">Cancel</button>
            </div>
        </div>
    </div>
</body>

</html>