<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinFlow - Transactions Overview</title>
    <link rel="stylesheet" href="style/transaction.css">
    <link rel="stylesheet" href="style/global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
    <div id="navbar"></div>
    <div class="transaction-container">
        <header>
            <h1>Your Transactions</h1>
            <div class="header-actions">
                <button id="deleteSelectedBtn" class="bulk-delete-btn" style="display: none;">Delete Selected</button>
                <a href="/dashboard.html" class="back-link">← Back to Dashboard</a>
                <a href="/add-transaction.html" class="add-transaction-btn">+ New Transaction</a>
                <a href="/upload-transactions.html" class="add-transaction-btn">+ Bulk Upload Transactions</a>
                <a id="exportCsvBtn" class="add-transaction-btn">Export CSV</a>
            </div>
        </header>

        <div id="transactionList" class="transaction-list">
            <p>Loading transactions...</p>
        </div>
    </div>

    <script>
        let currencySymbol = "€"; // default

        async function loadUserCurrencySymbol(user_uuid) {
            try {
                const res = await fetch(`/api/settings/${user_uuid}`);
                if (res.ok) {
                    const settings = await res.json();
                    if (settings.currency_symbol) {
                        currencySymbol = settings.currency_symbol;
                    }
                }
            } catch (err) {
                console.warn("Currency symbol fallback to €");
            }
        }
        // Global UUID access
        const storage = localStorage.getItem("session_token") ? localStorage : sessionStorage;
        const uuid = storage.getItem("user_uuid");

        function showConfirmModal(onConfirm) {
            const modal = document.getElementById("confirmModal");
            modal.style.display = "flex";

            const yesBtn = document.getElementById("confirmYes");
            const noBtn = document.getElementById("confirmNo");

            const cleanup = () => {
                modal.style.display = "none";
                yesBtn.removeEventListener("click", confirmHandler);
                noBtn.removeEventListener("click", cancelHandler);
            };

            const confirmHandler = () => {
                cleanup();
                onConfirm();
            };

            const cancelHandler = () => cleanup();

            yesBtn.addEventListener("click", confirmHandler);
            noBtn.addEventListener("click", cancelHandler);
        }

        fetch("/navbar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;
                document.getElementById("logoutBtn")?.addEventListener("click", () => {
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = "/login.html";
                });
            });

        document.addEventListener("DOMContentLoaded", async () => {
            document.getElementById("exportCsvBtn").addEventListener("click", () => {
                const rows = document.querySelectorAll(".transaction-table tbody tr");
                if (!rows.length) {
                    showAlert("No transaction records to export.", "error");
                    return;
                }

                const headers = ["From", "To", "Amount", "Description", "Date"];
                const csvRows = [headers.join(",")];

                rows.forEach(row => {
                    const from = row.children[1].textContent.trim();
                    const to = row.children[2].textContent.trim();
                    const amount = row.children[3].textContent.trim().replace(currencySymbol, "");
                    const description = row.children[4].textContent.trim();
                    const date = row.children[5].textContent.trim();

                    const csvRow = [from, to, amount, description, date]
                        .map(value => `"${value.replace(/"/g, '""')}"`) // escape quotes
                        .join(",");
                    csvRows.push(csvRow);
                });

                const csvContent = csvRows.join("\n");
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "transaction_data.csv");
                link.style.display = "none";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            const transactionList = document.getElementById("transactionList");

            if (!uuid) {
                window.location.href = "/login.html";
                return;
            }

            const updateCheckboxListeners = () => {
                const selectAll = document.getElementById("selectAll");
                const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
                const checkboxes = document.querySelectorAll(".row-checkbox");

                if (!selectAll || !deleteSelectedBtn) return;

                selectAll.addEventListener("change", () => {
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                    deleteSelectedBtn.style.display = checkboxes.length > 0 && selectAll.checked ? "inline-block" : "none";
                });

                checkboxes.forEach(cb => {
                    cb.addEventListener("change", () => {
                        const anyChecked = [...checkboxes].some(c => c.checked);
                        deleteSelectedBtn.style.display = anyChecked ? "inline-block" : "none";
                    });
                });

                deleteSelectedBtn.addEventListener("click", () => {
                    const selectedIds = [...checkboxes]
                        .filter(cb => cb.checked)
                        .map(cb => cb.dataset.id);

                    if (selectedIds.length === 0) return;

                    showConfirmModal(async () => {
                        for (const id of selectedIds) {
                            try {
                                const res = await fetch(`/api/transaction/${uuid}/${id}`, { method: "DELETE" });
                                if (res.ok) {
                                    const row = document.querySelector(`input[data-id="${id}"]`)?.closest("tr");
                                    if (row) {
                                        row.classList.add("fade-out");
                                        setTimeout(() => {
                                            row.remove();
                                            updateTotalSum(); // update the sum after removing
                                            const tbody = document.querySelector(".transaction-table tbody");
                                            if (!tbody || tbody.rows.length === 0) {
                                                transactionList.innerHTML = '<p class="fade-in">No transaction records found.</p>';
                                            }
                                        }, 400);
                                    }
                                }
                            } catch (err) {
                                console.error(`Failed to delete transaction ${id}`, err);
                            }
                        }

                        showAlert("Selected transactions deleted.", "success");
                        deleteSelectedBtn.style.display = "none";
                        document.getElementById("selectAll").checked = false;
                    });
                });
            };
            await loadUserCurrencySymbol(uuid);
            try {
                const [transactionsRes, accountsRes] = await Promise.all([
                    fetch(`/api/transactions/${uuid}`),
                    fetch(`/api/accounts/${uuid}`)
                ]);

                const transactions = await transactionsRes.json();
                const accounts = await accountsRes.json();

                if (!transactionsRes.ok || !Array.isArray(transactions)) throw new Error("Failed to load transactions.");
                if (!accountsRes.ok || !Array.isArray(accounts)) throw new Error("Failed to load accounts.");

                if (transactions.length === 0) {
                    transactionList.innerHTML = '<p>No transaction records found.</p>';
                    return;
                }

                const total = transactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                // Create a UUID-to-name lookup for accounts
                const accountMap = Object.fromEntries(accounts.map(account => [account.uuid, account.name]));

                const rows = transactions.map(transaction => {
                    const fromAccountName = accountMap[transaction.from_account] || 'Unknown';
                    const toAccountName = accountMap[transaction.to_account] || 'Unknown';

                    return `
    <tr>
      <td><input type="checkbox" class="row-checkbox" data-id="${transaction.uuid}" /></td>
      <td>${fromAccountName}</td>
      <td>${toAccountName}</td>
      <td>${currencySymbol}${parseFloat(transaction.amount).toFixed(2)}</td>
      <td>${transaction.description || '-'}</td>
        <td>${new Date(transaction.date || transaction.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
      <td>
        <button class="delete-btn" data-id="${transaction.uuid}" title="Delete">
          <i class="fas fa-trash-alt"></i>
        </button>
      </td>
    </tr>
  `;
                }).join('');

                transactionList.innerHTML = `
  <table class="transaction-table">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" title="Select All" /></th>
        <th class="sortable" data-key="from_account">From <i class="fas fa-sort"></i></th>
        <th class="sortable" data-key="to_account">To <i class="fas fa-sort"></i></th>
        <th class="sortable" data-key="amount">Amount <i class="fas fa-sort"></i></th>
        <th class="sortable" data-key="description">Description <i class="fas fa-sort"></i></th>
        <th class="sortable" data-key="created_at">Date <i class="fas fa-sort"></i></th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
    <tfoot>
      <tr>
        <td colspan="7" class="total-row">Total Transferred: <span id="totalSum">${currencySymbol}${total.toFixed(2)}</span></td>
      </tr>
    </tfoot>
  </table>`;

                updateCheckboxListeners();

                document.querySelectorAll(".delete-btn").forEach(button => {
                    button.addEventListener("click", () => {
                        const id = button.dataset.id;

                        showConfirmModal(async () => {
                            const res = await fetch(`/api/transaction/${uuid}/${id}`, { method: "DELETE" });
                            const result = await res.json();

                            if (res.ok) {
                                const row = button.closest("tr");
                                row.classList.add("fade-out");
                                setTimeout(() => {
                                    row.remove();
                                    const tbody = document.querySelector(".transaction-table tbody");
                                    if (!tbody || tbody.rows.length === 0) {
                                        transactionList.innerHTML = '<p class="fade-in">No transaction records found.</p>';
                                    }
                                }, 400);
                                showAlert("Transaction deleted.", "success");
                            } else {
                                showAlert(result.error || "Failed to delete transaction.", "error");
                            }
                        });
                    });
                });

            } catch (err) {
                console.error(err);
                transactionList.innerHTML = '<p class="error">Failed to load transaction data.</p>';
            }
        });

        function showAlert(message, type = "success") {
            const alert = document.createElement("div");
            alert.className = `alert-box ${type}`;
            alert.innerText = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
        function updateTotalSum() {
            const rows = document.querySelectorAll(".transaction-table tbody tr");
            let newTotal = 0;

            rows.forEach(row => {
                const amountCell = row.querySelector("td:nth-child(3)");
                if (amountCell) {
                    const amount = parseFloat(amountCell.textContent.replace(/[^\d.-]/g, ""));
                    if (!isNaN(amount)) newTotal += amount;
                }
            });

            const totalElem = document.getElementById("totalSum");
            if (totalElem) {
                totalElem.textContent = `${currencySymbol}${newTotal.toFixed(2)}`;
            }
        }
        let currentSort = { key: null, direction: "asc" };

        document.addEventListener("click", e => {
            const header = e.target.closest(".sortable");
            if (!header) return;

            const key = header.dataset.key;
            const direction = (currentSort.key === key && currentSort.direction === "asc") ? "desc" : "asc";
            currentSort = { key, direction };

            sortTableByKey(key, direction);
            updateSortIcons(key, direction);
        });

        function sortTableByKey(key, direction) {
            const tbody = document.querySelector(".transaction-table tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));

            rows.sort((a, b) => {
                const aData = extractCellValue(a, key);
                const bData = extractCellValue(b, key);

                if (typeof aData === "number" && typeof bData === "number") {
                    return direction === "asc" ? aData - bData : bData - aData;
                }

                return direction === "asc"
                    ? String(aData).localeCompare(String(bData))
                    : String(bData).localeCompare(String(aData));
            });

            tbody.innerHTML = "";
            rows.forEach(row => tbody.appendChild(row));
        }

        function extractCellValue(row, key) {
            switch (key) {
                case "name":
                    return row.children[1].textContent.trim().toLowerCase();
                case "amount":
                    return parseFloat(row.children[2].textContent.replace(/[^\d.-]/g, ""));
                case "tags":
                    return row.children[3].textContent.trim().toLowerCase();
                case "created_at":
                    return new Date(row.children[4].textContent);
                case "month":
                    return row.children[5].textContent.trim().toLowerCase();
                case "account_name":
                    return row.children[6].textContent.trim().toLowerCase();
                default:
                    return "";
            }
        }

        function updateSortIcons(activeKey, direction) {
            document.querySelectorAll(".sortable").forEach(th => {
                th.classList.remove("active");
                const icon = th.querySelector("i");
                icon.className = "fas fa-sort";
                if (th.dataset.key === activeKey) {
                    th.classList.add("active");
                    icon.className = direction === "asc" ? "fas fa-sort-up" : "fas fa-sort-down";
                }
            });
        }
    </script>

    <div id="confirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <p>Are you sure you want to delete this transaction?</p>
            <div class="modal-actions">
                <button id="confirmYes" class="modal-btn danger">Yes, delete</button>
                <button id="confirmNo" class="modal-btn">Cancel</button>
            </div>
        </div>
    </div>
</body>

</html>