<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoinFlow - Dashboard</title>
  <link rel="stylesheet" href="style/dashboard.css">
  <link rel="stylesheet" href="style/global.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
</head>

<body>
  <div id="navbar"></div>

  <main class="dashboard-main">
    <h2>Hello, <span id="username">User</span> ðŸ‘‹</h2>
    <p>This is your personal finance dashboard.</p>
    <section class="dashboard-split">
      <div class="chart-section">
        <h3>Monthly Net</h3>
        <canvas id="monthlyNetChart" width="600" height="300"></canvas>
      </div>

      <aside class="accounts-section">
        <h3>Banks</h3>
        <div id="dashboardAccountsContainer" class="dashboard-accounts-container">Loading accounts...</div>
      </aside>
    </section><br><br><br><br>

    <div class="chart-section">
      <h3>Expenses by Category</h3><br>

      <section class="pie-charts-row">
        <div class="pie-chart">
          <h4>Income</h4>
          <canvas id="incomePieChart"></canvas>
        </div>

        <div class="pie-chart">
          <h4>Expenses</h4>
          <canvas id="categoryPieChart"></canvas>
        </div>

        <div class="pie-chart">
          <h4>Transactions</h4>
          <canvas id="transactionPieChart"></canvas>
        </div>
      </section>
    </div><br><br><br>

    <section>
      <div class="chart-section">
        <h3>Incomes vs Expenses</h3>
        <canvas id="incomeExpenseBarChart" width="900" height="300"></canvas>
      </div>
    </section>
  </main>



  <script>
    let currencySymbol = "â‚¬"; // default
    document.addEventListener("DOMContentLoaded", () => {
      async function loadUserCurrencySymbol(user_uuid) {
        try {
          const res = await fetch(`/api/settings/${user_uuid}`);
          if (res.ok) {
            const settings = await res.json();
            if (settings.currency_symbol) {
              currencySymbol = settings.currency_symbol;
            }
          }
        } catch (err) {
          console.warn("Failed to fetch user currency settings, defaulting to ${currencySymbol}.");
        }
      }

      const storage = localStorage.getItem("session_token") ? localStorage : sessionStorage;
      const token = storage.getItem("session_token");
      const uuid = storage.getItem("user_uuid");

      if (!token || !uuid) {
        window.location.href = "/login.html";
        return;
      } else {
        (async () => {
          await loadUserCurrencySymbol(uuid);

          fetch(`/api/user/${uuid}`)
            .then(response => response.json())
            .then(data => {
              const usernameElement = document.getElementById("username");
              if (usernameElement && data.username) {
                usernameElement.textContent = data.username;
                storage.setItem("username", data.username);
              }
            })
            .catch(error => console.error("Error fetching username:", error));

          await loadMonthlyNetChart(uuid);
          await loadDashboardAccounts(uuid);
          await loadExpensesPieChart(uuid);
          await loadIncomePieChart(uuid);
          await loadTransactionPieChart(uuid);
          await loadIncomeExpenseBarChart(uuid);
        })();
      }

      async function loadMonthlyNetChart(uuid) {
        const [incomesRes, expensesRes] = await Promise.all([
          fetch(`/api/incomes/${uuid}`),
          fetch(`/api/expenses/${uuid}`)
        ]);

        const incomes = await incomesRes.json();
        const expenses = await expensesRes.json();

        const months = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];

        const monthlyNet = {};

        // Initialize each month to 0
        months.forEach(m => monthlyNet[m] = 0);

        // Don't skip months that have a 0 value!
        incomes.forEach(i => {
          if (i.month && monthlyNet.hasOwnProperty(i.month)) {
            monthlyNet[i.month] += parseFloat(i.amount);
          }
        });

        expenses.forEach(e => {
          if (e.month && monthlyNet.hasOwnProperty(e.month)) {
            monthlyNet[e.month] -= parseFloat(e.amount);
          }
        });

        const data = months.map(m => monthlyNet[m]);

        const canvas = document.getElementById("monthlyNetChart");
        if (!canvas) {
          console.error("Canvas #monthlyNetChart not found");
          return;
        }

        const ctx = canvas.getContext("2d");

        const borderColors = data.map(value => value < 0 ? "#e74c3c" : "#3498db");
        const backgroundColors = data.map(value => value < 0 ? "rgba(231, 76, 60, 0.1)" : "rgba(52, 152, 219, 0.1)");

        new Chart(ctx, {
          type: "line",
          data: {
            labels: months,
            datasets: [{
              label: "Monthly Net",
              data,
              fill: true,
              backgroundColor: "rgba(52, 152, 219, 0.1)", // fallback
              borderColor: "#3498db", // fallback
              borderWidth: 2,
              tension: 0.3,

              // Point styling
              pointBackgroundColor: data.map(value =>
                value < 0 ? "#e74c3c" : value > 0 ? "#2ecc71" : "#3498db"
              ),
              pointBorderColor: data.map(value =>
                value < 0 ? "#e74c3c" : value > 0 ? "#2ecc71" : "#3498db"
              ),
              pointRadius: 4,

              // Segment styling
              segment: {
                borderColor: ctx => {
                  const i = ctx.p0DataIndex;
                  const val = data[i];
                  const nextVal = data[i + 1];
                  return (val < 0 || nextVal < 0)
                    ? "#e74c3c"
                    : (val > 0 || nextVal > 0)
                      ? "#2ecc71"
                      : "#3498db";
                },
                backgroundColor: ctx => {
                  const i = ctx.p0DataIndex;
                  const val = data[i];
                  const nextVal = data[i + 1];
                  return (val < 0 || nextVal < 0)
                    ? "rgba(231, 76, 60, 0.1)"
                    : (val > 0 || nextVal > 0)
                      ? "rgba(46, 204, 113, 0.1)"
                      : "rgba(52, 152, 219, 0.1)";
                }
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: value => `${currencySymbol}${(value / 1000).toFixed(1)}K`
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => `${currencySymbol}${ctx.raw.toFixed(2)}`
                }
              }
            }
          }
        });
      }



      async function loadDashboardAccounts(uuid) {
        const container = document.getElementById("dashboardAccountsContainer");
        container.innerHTML = "";

        try {
          const res = await fetch(`/api/accounts/${uuid}`);
          const accounts = await res.json();

          if (!accounts.length) {
            container.textContent = "No accounts found.";
            return;
          }

          accounts.forEach(account => {
            const card = document.createElement("div");
            card.className = "dashboard-account-card";

            // Choose image based on name/type â€” fallback to cash
            const logoMap = {
              "santander": "santander.png",
              "erste": "erste.png",
              "bargeld": "cash.jpg"
            };
            const nameKey = account.name.toLowerCase();
            const imgSrc = `/assets/banks/${logoMap[nameKey] || "default.png"}`;

            card.innerHTML = `
  <div class="bank-info">
    <h4>${account.name}</h4>
    <p><strong>Balance:</strong> ${currencySymbol}${parseFloat(account.balance).toFixed(2)}</p>
  </div>
`;
            container.appendChild(card);
          });

        } catch (err) {
          container.textContent = "Error loading accounts.";
          console.error(err);
        }
      }


      document.getElementById("username").textContent = username;

      // Load navbar.html
      fetch("/navbar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("navbar").innerHTML = html;

          document.getElementById("logoutBtn")?.addEventListener("click", () => {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = "/login.html";
          });
        });
    });

    async function loadIncomePieChart(uuid) {
      try {
        const ctx = document.getElementById("incomePieChart")?.getContext("2d");
        if (!ctx) {
          console.error("Canvas #incomePieChart not found");
          return;
        }

        const res = await fetch(`/api/incomes/${uuid}`);
        if (!res.ok) throw new Error("Failed to fetch incomes");
        const incomes = await res.json();

        if (!incomes.length) {
          createNoDataChart(ctx, "#b5b5b5");
          return;
        }

        // Group and sum income amounts by name
        const grouped = {};
        incomes.forEach(i => {
          const name = i.name || "Unbenannt";
          grouped[name] = (grouped[name] || 0) + parseFloat(i.amount);
        });

        const labels = Object.keys(grouped);
        const data = Object.values(grouped);

        const colors = [
          "#3498db", "#e74c3c", "#2ecc71", "#f1c40f", "#9b59b6",
          "#e67e22", "#1abc9c", "#34495e", "#95a5a6", "#d35400"
        ];

        new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
              borderColor: "#fff",
              borderWidth: 2
            }]
          },
          options: {
            plugins: {
              legend: {
                position: "right"
              },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.label}: â‚¬${ctx.raw.toFixed(2)}`
                }
              }
            }
          }
        });

      } catch (error) {
        console.error("Error loading income pie chart:", error);
      }
    }

    async function loadExpensesPieChart(uuid) {
      const ctx = document.getElementById("categoryPieChart")?.getContext("2d");
      if (!ctx) {
        console.error("Canvas #categoryPieChart not found");
        return;
      }

      const res = await fetch(`/api/expenses/${uuid}`);
      const expenses = await res.json();

      if (!expenses.length) {
        createNoDataChart(ctx, "#8f8f8f");
        return;
      }

      // Group and sum expense amounts by name
      const grouped = {};
      expenses.forEach(e => {
        const name = e.name || "Unbenannt";
        grouped[name] = (grouped[name] || 0) + parseFloat(e.amount);
      });

      const labels = Object.keys(grouped);
      const data = Object.values(grouped);

      const colors = [
        "#3498db", "#e74c3c", "#2ecc71", "#f1c40f", "#9b59b6",
        "#e67e22", "#1abc9c", "#34495e", "#95a5a6", "#d35400"
      ];

      new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: "#fff",
            borderWidth: 2
          }]
        },
        options: {
          plugins: {
            legend: {
              position: "right"
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || "Unbenannt";
                  const value = context.raw || 0;
                  return `${label}: ${value.toFixed(2)}â‚¬`;
                }
              }
            }
          }
        }
      });
    }

    async function loadTransactionPieChart(user_uuid) {
      try {
        const ctx = document.getElementById("transactionPieChart").getContext("2d");
        if (window.pieChartInstance) window.pieChartInstance.destroy();

        const txRes = await fetch(`/api/transactions/${user_uuid}`);
        const transactions = await txRes.json();

        const accRes = await fetch(`/api/accounts/${user_uuid}`);
        const accounts = await accRes.json();

        if (!transactions.length) {
          createNoDataChart(ctx, "#717171");
          return;
        }

        const accountMap = {};
        for (const acc of accounts) {
          accountMap[acc.uuid] = acc.name;
        }

        // Group and sum transaction amounts by destination account (to_account) name
        const grouped = {};
        for (const tx of transactions) {
          const to = accountMap[tx.to_account] || tx.to_account;
          const amount = Number(tx.amount);
          grouped[to] = (grouped[to] || 0) + amount;
        }

        const labels = Object.keys(grouped);
        const data = Object.values(grouped);

        const colors = [
          "#3498db", "#e74c3c", "#2ecc71", "#f1c40f", "#9b59b6",
          "#e67e22", "#1abc9c", "#34495e", "#95a5a6", "#d35400"
        ];

        window.pieChartInstance = new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
            }],
          },
          options: {
            plugins: {
              legend: {
                position: "right"
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.raw || 0;
                    return `${label}: ${value.toFixed(2)}â‚¬`;
                  }
                }
              }
            }
          }
        });
      } catch (err) {
        console.error("Fehler beim Laden des Pie Charts:", err);
      }
    }

    function createNoDataChart(ctx, color, text = "No data") {
      new Chart(ctx, {
        type: "pie",
        data: {
          labels: [text],
          datasets: [{
            data: [1],
            backgroundColor: [color],
            borderColor: "#fff",
            borderWidth: 2
          }]
        },
        options: {
          plugins: {
            legend: { position: "right" },
            tooltip: {
              callbacks: {
                title: () => '',
                label: () => text
              }
            },
          }
        }
      });
    }

    async function loadIncomeExpenseBarChart(uuid) {
      const [incomeRes, expenseRes] = await Promise.all([
        fetch(`/api/incomes/${uuid}`),
        fetch(`/api/expenses/${uuid}`)
      ]);

      const incomes = await incomeRes.json();
      const expenses = await expenseRes.json();

      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];

      function groupByMonth(data) {
        const result = {};
        months.forEach(month => result[month] = 0);
        data.forEach(item => {
          if (months.includes(item.month)) {
            result[item.month] += parseFloat(item.amount);
          }
        });
        return result;
      }

      const incomePerMonth = groupByMonth(incomes);
      const expensePerMonth = groupByMonth(expenses);

      const ctx = document.getElementById("incomeExpenseBarChart")?.getContext("2d");
      if (!ctx) return;

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: months,
          datasets: [
            {
              label: "Income",
              data: months.map(m => incomePerMonth[m]),
              backgroundColor: "#2ecc71"
            },
            {
              label: "Expenses",
              data: months.map(m => expensePerMonth[m]),
              backgroundColor: "#e74c3c"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: `Amount in ${currencySymbol}`
              }
            },
            x: {
              title: {
                display: true,
                text: "Month"
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.raw.toFixed(2)}`
              }
            }
          }
        }
      });
    }





  </script>
</body>

</html>