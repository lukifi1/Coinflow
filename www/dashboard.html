<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoinFlow - Dashboard</title>
  <link rel="stylesheet" href="style/dashboard.css">
  <link rel="stylesheet" href="style/global.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
</head>

<body>
  <div id="navbar"></div>

  <main class="dashboard-main">
    <h2>Hello, <span id="username">User</span> ðŸ‘‹</h2>
    <p>This is your personal finance dashboard.</p><br><br>
    <section class="dashboard-split">
      <div class="chart-section">
        <h3>Monthly Net</h3>
        <canvas id="monthlyNetChart" width="600" height="300"></canvas>
      </div>

      <aside class="accounts-section">
        <h3>Banks</h3>
        <div id="dashboardAccountsContainer" class="dashboard-accounts-container">Loading accounts...</div>
      </aside>
    </section><br><br><br><br>

    <div class="chart-section">
      <h3>Expenses by Category</h3><br>
      <section class="pie-charts-row">
        <section class="pie-chart-section income-pie-chart-section">
          <div class="pie-chart">
            <h4>Income</h4>
            <canvas id="incomePieChart"></canvas>
          </div>
        </section>
        <section class="pie-chart-section expenses-pie-chart-section">
          <div class="pie-chart">
            <h4>Expenses</h4>
            <canvas id="categoryPieChart"></canvas>
          </div>
        </section>
        <section class="pie-chart-section transactions-pie-chart-section">
          <div class="pie-chart">
            <h4>Transactions</h4>
            <canvas id="transactionPieChart"></canvas>
          </div>
        </section>
      </section>
    </div><br><br><br>

    <section class="bar-chart-section income-expense-bar-chart-section">
      <div class="chart-section">
        <h3>Incomes vs Expenses</h3>
        <canvas id="incomeExpenseBarChart" width="900" height="300"></canvas>
      </div>
    </section><br><br><br>

    <div id="totalSavingsDiv">            
      <section id="totalSavingsSection" >
      <h3>Total Savings</h3><br>
      <div id="totalSavingsContainer" ></div>
      </section>
      </div>  
  </main>



  <script>
    let currencySymbol = "â‚¬"; // default
    document.addEventListener("DOMContentLoaded", () => {
      async function loadUserCurrencySymbol(user_uuid) {
        try {
          const res = await fetch(`/api/settings/${user_uuid}`);
          if (res.ok) {
            const settings = await res.json();
            if (settings.currency_symbol) {
              currencySymbol = settings.currency_symbol;
            }
          }
        } catch (err) {
          console.warn("Failed to fetch user currency settings, defaulting to ${currencySymbol}.");
        }
      }

      const storage = localStorage.getItem("session_token") ? localStorage : sessionStorage;
      const token = storage.getItem("session_token");
      const uuid = storage.getItem("user_uuid");

      if (!token || !uuid) {
        window.location.href = "/login.html";
        return;
      } else {
        (async () => {
          await loadUserCurrencySymbol(uuid);

          fetch(`/api/user/${uuid}`)
            .then(response => response.json())
            .then(data => {
              const usernameElement = document.getElementById("username");
              if (usernameElement && data.username) {
                usernameElement.textContent = data.username;
                storage.setItem("username", data.username);
              }
            })
            .catch(error => console.error("Error fetching username:", error));

          await loadMonthlyNetChart(uuid);
          await loadDashboardAccounts(uuid);
          // Animate pie/bar charts only when visible
          animateOnView("categoryPieChart", () => loadExpensesPieChart(uuid));
          animateOnView("incomePieChart", () => loadIncomePieChart(uuid));
          animateOnView("incomeExpenseBarChart", () => loadIncomeExpenseBarChart(uuid));
          // Transaction pie chart loads as before (not deferred)
          await loadTransactionPieChart(uuid);
          await loadTotalSavings(uuid);
        })();
      }

      async function loadMonthlyNetChart(uuid) {
        const [incomesRes, expensesRes] = await Promise.all([
          fetch(`/api/incomes/${uuid}`),
          fetch(`/api/expenses/${uuid}`)
        ]);

        const incomes = await incomesRes.json();
        const expenses = await expensesRes.json();

        const months = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];

        const monthlyNet = {};
        months.forEach(m => monthlyNet[m] = 0);

        // Use date field if available, fallback to created_at
        incomes.forEach(i => {
          const effectiveDate = i.date || i.created_at;
          if (effectiveDate) {
            const d = new Date(effectiveDate);
            const monthName = months[d.getMonth()];
            if (monthlyNet.hasOwnProperty(monthName)) {
              monthlyNet[monthName] += parseFloat(i.amount);
            }
          }
        });
        expenses.forEach(e => {
          const effectiveDate = e.date || e.created_at;
          if (effectiveDate) {
            const d = new Date(effectiveDate);
            const monthName = months[d.getMonth()];
            if (monthlyNet.hasOwnProperty(monthName)) {
              monthlyNet[monthName] -= parseFloat(e.amount);
            }
          }
        });

        const data = months.map(m => monthlyNet[m]);

        const canvas = document.getElementById("monthlyNetChart");
        if (!canvas) {
          console.error("Canvas #monthlyNetChart not found");
          return;
        }

        const ctx = canvas.getContext("2d");

        const borderColors = data.map(value => value < 0 ? "#e74c3c" : "#3498db");
        const backgroundColors = data.map(value => value < 0 ? "rgba(231, 76, 60, 0.1)" : "rgba(52, 152, 219, 0.1)");

        new Chart(ctx, {
          type: "line",
          data: {
            labels: months,
            datasets: [{
              label: "Monthly Net",
              data,
              fill: true,
              backgroundColor: "rgba(52, 152, 219, 0.1)", // fallback
              borderColor: "#3498db", // fallback
              borderWidth: 2,
              tension: 0.3,
              pointBackgroundColor: data.map(value =>
                value < 0 ? "#e74c3c" : value > 0 ? "#2ecc71" : "#3498db"
              ),
              pointBorderColor: data.map(value =>
                value < 0 ? "#e74c3c" : value > 0 ? "#2ecc71" : "#3498db"
              ),
              pointRadius: 4,
              segment: {
                borderColor: ctx => {
                  const i = ctx.p0DataIndex;
                  const val = data[i];
                  const nextVal = data[i + 1];
                  return (val < 0 || nextVal < 0)
                    ? "#e74c3c"
                    : (val > 0 || nextVal > 0)
                      ? "#2ecc71"
                      : "#3498db";
                },
                backgroundColor: ctx => {
                  const i = ctx.p0DataIndex;
                  const val = data[i];
                  const nextVal = data[i + 1];
                  return (val < 0 || nextVal < 0)
                    ? "rgba(231, 76, 60, 0.1)"
                    : (val > 0 || nextVal > 0)
                      ? "rgba(46, 204, 113, 0.1)"
                      : "rgba(52, 152, 219, 0.1)";
                }
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: value => `${currencySymbol}${(value / 1000).toFixed(1)}K`
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => `${currencySymbol}${ctx.raw.toFixed(2)}`
                }
              }
            }
          }
        });
      }



      async function loadDashboardAccounts(uuid) {
        const container = document.getElementById("dashboardAccountsContainer");
        container.innerHTML = "";

        try {
          const res = await fetch(`/api/accounts/${uuid}`);
          const accounts = await res.json();

          if (!accounts.length) {
            container.textContent = "No accounts found.";
            return;
          }

          accounts.forEach(account => {
            const card = document.createElement("div");
            card.className = "dashboard-account-card";

            // Choose image based on name/type â€” fallback to cash
            const logoMap = {
              "santander": "santander.png",
              "erste": "erste.png",
              "bargeld": "cash.jpg"
            };
            const nameKey = account.name.toLowerCase();
            const imgSrc = `/assets/banks/${logoMap[nameKey] || "default.png"}`;

            card.innerHTML = `
  <div class="bank-info">
    <h4>${account.name}</h4>
    <p><strong>Balance:</strong> ${currencySymbol}${parseFloat(account.balance).toFixed(2)}</p>
  </div>
`;
            container.appendChild(card);
          });

        } catch (err) {
          container.textContent = "Error loading accounts.";
          console.error(err);
        }
      }


      document.getElementById("username").textContent = username;

      // Load navbar.html
      fetch("/navbar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("navbar").innerHTML = html;

          document.getElementById("logoutBtn")?.addEventListener("click", () => {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = "/login.html";
          });
        });
    });

    async function loadIncomePieChart(uuid) {
      try {
        const ctx = document.getElementById("incomePieChart")?.getContext("2d");
        if (!ctx) {
          console.error("Canvas #incomePieChart not found");
          return;
        }

        const res = await fetch(`/api/incomes/${uuid}`);
        if (!res.ok) throw new Error("Failed to fetch incomes");
        const incomes = await res.json();

        if (!incomes.length) {
          createNoDataChart(ctx, "#b5b5b5");
          return;
        }

        // Group and sum income amounts by name
        const grouped = {};
        incomes.forEach(i => {
          const name = i.name || "Unbenannt";
          grouped[name] = (grouped[name] || 0) + parseFloat(i.amount);
        });

        const labels = Object.keys(grouped);
        const data = Object.values(grouped);

        const colors = [
          "#3498db", "#e74c3c", "#2ecc71", "#f1c40f", "#9b59b6",
          "#e67e22", "#1abc9c", "#34495e", "#95a5a6", "#d35400"
        ];

        new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
              borderColor: "#fff",
              borderWidth: 2
            }]
          },
          options: {
            plugins: {
              legend: {
                position: "right"
              },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.label}: ${currencySymbol}${ctx.raw.toFixed(2)}`
                }
              }
            }
          }
        });

      } catch (error) {
        console.error("Error loading income pie chart:", error);
      }
    }

    async function loadExpensesPieChart(uuid) {
      const ctx = document.getElementById("categoryPieChart")?.getContext("2d");
      if (!ctx) {
        console.error("Canvas #categoryPieChart not found");
        return;
      }

      const res = await fetch(`/api/expenses/${uuid}`);
      const expenses = await res.json();

      if (!expenses.length) {
        createNoDataChart(ctx, "#8f8f8f");
        return;
      }

      // Group and sum expense amounts by name
      const grouped = {};
      expenses.forEach(e => {
        const name = e.name || "Unbenannt";
        grouped[name] = (grouped[name] || 0) + parseFloat(e.amount);
      });

      const labels = Object.keys(grouped);
      const data = Object.values(grouped);

      const colors = [
        "#3498db", "#e74c3c", "#2ecc71", "#f1c40f", "#9b59b6",
        "#e67e22", "#1abc9c", "#34495e", "#95a5a6", "#d35400"
      ];

      new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: "#fff",
            borderWidth: 2
          }]
        },
        options: {
          animation: {
            animateRotate: true,
            animateScale: true
          },
          plugins: {
            legend: {
              position: "right"
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || "Unbenannt";
                  const value = context.raw || 0;
                  return `${label}: ${value.toFixed(2)}${currencySymbol}`;
                }
              }
            }
          }
        }
      });
    }

    async function loadTransactionPieChart(user_uuid) {
      try {
        const ctx = document.getElementById("transactionPieChart").getContext("2d");
        if (window.pieChartInstance) window.pieChartInstance.destroy();

        const txRes = await fetch(`/api/transactions/${user_uuid}`);
        const transactions = await txRes.json();

        const accRes = await fetch(`/api/accounts/${user_uuid}`);
        const accounts = await accRes.json();

        if (!transactions.length) {
          createNoDataChart(ctx, "#717171");
          return;
        }

        const accountMap = {};
        for (const acc of accounts) {
          accountMap[acc.uuid] = acc.name;
        }

        // Group and sum transaction amounts by destination account (to_account) name
        const grouped = {};
        for (const tx of transactions) {
          const to = accountMap[tx.to_account] || tx.to_account;
          const amount = Number(tx.amount);
          grouped[to] = (grouped[to] || 0) + amount;
        }

        const labels = Object.keys(grouped);
        const data = Object.values(grouped);

        const colors = [
          "#3498db", "#e74c3c", "#2ecc71", "#f1c40f", "#9b59b6",
          "#e67e22", "#1abc9c", "#34495e", "#95a5a6", "#d35400"
        ];

        window.pieChartInstance = new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
            }],
          },
          options: {
            plugins: {
              legend: {
                position: "right"
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.raw || 0;
                    return `${label}: ${value.toFixed(2)}${currencySymbol}`;
                  }
                }
              }
            }
          }
        });
      } catch (err) {
        console.error("Fehler beim Laden des Pie Charts:", err);
      }
    }

    function createNoDataChart(ctx, color, text = "No data") {
      new Chart(ctx, {
        type: "pie",
        data: {
          labels: [text],
          datasets: [{
            data: [1],
            backgroundColor: [color],
            borderColor: "#fff",
            borderWidth: 2
          }]
        },
        options: {
          plugins: {
            legend: { position: "right" },
            tooltip: {
              callbacks: {
                title: () => '',
                label: () => text
              }
            },
          }
        }
      });
    }

    async function loadIncomeExpenseBarChart(uuid) {
      const [incomeRes, expenseRes] = await Promise.all([
        fetch(`/api/incomes/${uuid}`),
        fetch(`/api/expenses/${uuid}`)
      ]);

      const incomes = await incomeRes.json();
      const expenses = await expenseRes.json();

      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];

      function groupByMonth(data) {
        const result = {};
        months.forEach(month => result[month] = 0);
        data.forEach(item => {
          // Always derive the month from item.date or item.created_at
          const monthName = new Date(item.date || item.created_at).toLocaleString('en-US', { month: 'long' });
          if (months.includes(monthName)) {
            result[monthName] += parseFloat(item.amount);
          }
        });
        return result;
      }

      const incomePerMonth = groupByMonth(incomes);
      const expensePerMonth = groupByMonth(expenses);

      const ctx = document.getElementById("incomeExpenseBarChart")?.getContext("2d");
      if (!ctx) return;

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: months,
          datasets: [
            {
              label: "Income",
              data: months.map(m => incomePerMonth[m]),
              backgroundColor: "#2ecc71"
            },
            {
              label: "Expenses",
              data: months.map(m => expensePerMonth[m]),
              backgroundColor: "#e74c3c"
            }
          ]
        },
        options: {
          responsive: true,
          animation: {
            duration: 800,
            easing: "easeOutQuart"
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: `Amount in ${currencySymbol}`
              }
            },
            x: {
              title: {
                display: true,
                text: "Month"
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.raw.toFixed(2)}`
              }
            }
          }
        }
      });
    }
function animateOnView(canvasId, loadChartFn) {
      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            loadChartFn();
            obs.unobserve(entry.target);
          }
        });
      }, {
        root: null,
        rootMargin: "0px",
        threshold: 0.3
      });

      const target = document.getElementById(canvasId);
      if (target) {
        observer.observe(target);
      }
    }

        async function loadTotalSavings(uuid) {
  const container = document.getElementById("totalSavingsContainer");
  if (!container) return;

  // Monatsnamen (auf Englisch, kann angepasst werden)
  const months = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];

  try {
    const [incomeRes, expenseRes] = await Promise.all([
      fetch(`/api/incomes/${uuid}`),
      fetch(`/api/expenses/${uuid}`)
    ]);
    if (!incomeRes.ok || !expenseRes.ok) {
      container.textContent = "Failed to load data";
      return;
    }

    const incomes = await incomeRes.json();
    const expenses = await expenseRes.json();


    const incomeByMonth = {};
    const expenseByMonth = {};
    months.forEach(m => {
      incomeByMonth[m] = 0;
      expenseByMonth[m] = 0;
    });

    incomes.forEach(i => {
      const date = new Date(i.date || i.created_at);
      const monthName = months[date.getMonth()];
      incomeByMonth[monthName] += parseFloat(i.amount);
    });

    expenses.forEach(e => {
      const date = new Date(e.date || e.created_at);
      const monthName = months[date.getMonth()];
      expenseByMonth[monthName] += parseFloat(e.amount);
    });

    container.innerHTML = "";

    months.forEach(month => {
      const income = incomeByMonth[month].toFixed(2);
      const expense = expenseByMonth[month].toFixed(2);
      const net = (incomeByMonth[month] - expenseByMonth[month]).toFixed(2);

      const monthDiv = document.createElement("div");
      monthDiv.style.border = "1px solid #ccc";
      monthDiv.style.padding = "1rem";
      monthDiv.style.borderRadius = "8px";
      monthDiv.style.width = "200px";
      monthDiv.style.margin = "0.5rem";
      monthDiv.style.cursor = "pointer";
      monthDiv.style.userSelect = "none";

      monthDiv.innerHTML = `
        <h4>${month}</h4>
        <p>Income: ${currencySymbol}${income}</p>
        <p>Expenses: ${currencySymbol}${expense}</p>
        <p>Net: ${currencySymbol}${net}</p>
      `;

      monthDiv.addEventListener("click", () => {
        showMonthDetails(month, incomes, expenses);
      });

      container.appendChild(monthDiv);
    });

  } catch (err) {
    container.textContent = "Error loading total savings.";
    console.error(err);
  }
}


function showMonthDetails(month, incomes, expenses) {
  function filterByMonth(data) {
    return data.filter(item => {
      const dateStr = item.date || item.created_at;
      if (!dateStr) return false;
      const d = new Date(dateStr);
      return d.toLocaleString('en-US', { month: 'long' }) === month;
    });
  }

  const incomesOfMonth = filterByMonth(incomes);
  const expensesOfMonth = filterByMonth(expenses);

  const totalIncome = incomesOfMonth.reduce((sum, i) => sum + parseFloat(i.amount), 0);
  const totalExpenses = expensesOfMonth.reduce((sum, e) => sum + parseFloat(e.amount), 0);
  const totalNet =totalIncome - totalExpenses;

  const modalHtml = `
  <div id="monthModal" style="
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
    z-index: 9999;
  ">
    <div style="
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    ">
      <button id="closeMonthModal" style="
        position: absolute; top: 10px; right: 10px;
        background: transparent; border: none;
        font-size: 1.5rem; cursor: pointer;
      ">Ã—</button>

      <p style="margin-bottom: 20px; font-weight: bold; font-size: 24px;">
        Details for ${month}
      </p>

      <h3><strong>Total Net: ${currencySymbol}${totalNet.toFixed(2)}</strong></h3><br>
      <h3><strong>Total Income: ${currencySymbol}${totalIncome.toFixed(2)}</strong></h3>
      <ul>
        ${incomesOfMonth.map(i => `<li>${i.name || "Unbenannt"}: ${currencySymbol}${parseFloat(i.amount).toFixed(2)}</li>`).join("") || "<li>Keine EinkÃ¼nfte</li>"}
      </ul><br>

      <h3><strong>Total Expenses: ${currencySymbol}${totalExpenses.toFixed(2)}</strong></h3>
      <ul>
        ${expensesOfMonth.map(e => `<li>${e.name || "Unbenannt"}: ${currencySymbol}${parseFloat(e.amount).toFixed(2)}</li>`).join("") || "<li>Keine Ausgaben</li>"}
      </ul>
    </div>
  </div>
`;


  const modalWrapper = document.createElement("div");
  modalWrapper.innerHTML = modalHtml;
  document.body.appendChild(modalWrapper);

  document.getElementById("closeMonthModal").addEventListener("click", () => {
    modalWrapper.remove();
  });

  modalWrapper.firstChild.addEventListener("click", e => {
    if (e.target === modalWrapper.firstChild) modalWrapper.remove();
  });
}

// Und zum Initialisieren:

document.addEventListener("DOMContentLoaded", () => {
  const storage = localStorage.getItem("session_token") ? localStorage : sessionStorage;
  const uuid = storage.getItem("user_uuid");
  if (uuid) {
    loadTotalSavings(uuid);
  }
});

  </script>
</body>

</html>